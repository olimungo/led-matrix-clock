#include <math.h>
#include <stdio.h>
#include <EEPROM.h>
#include <TimeLib.h>
#include <Wire.h>
#include <LEDMatrixDriver.hpp>
#include <DS1302.h>
// #include <Rtc_Pcf8563.h> // SCL - A5, SDA - A4, INT - 3

#define CLOCK_DS1302 1

#define ROWS 8
#define NUM_DEVICES 4

#define CLOCK_RESET 5
#define CLOCK_DATA 6
#define CLOCK_CLOCK 7

#define MATRIX_CS_PIN 9 // DIN (MOSI) : 11 - CLK: 13

#define MAIN_SWITCH_PIN 0
#define SECONDARY_SWITCH_PIN 2
#define TERNARY_SWITCH_PIN 3

#define BUZZER 4

#define MODE_CLOCK 0
#define MODE_CHRONO 1
#define MODE_TIMER 2
#define MODE_SET_CLOCK 3
#define MODE_SETUP 4
#define MODE_EASTER_EGG 5

#define SETCLOCK_HOUR1 0
#define SETCLOCK_HOUR2 1
#define SETCLOCK_MINUTE1 2
#define SETCLOCK_MINUTE2 3

#define CHRONO_PAUSED 0
#define CHRONO_RUNNING 1

#define TIMER_HOUR1 0
#define TIMER_HOUR2 1
#define TIMER_MINUTE1 2
#define TIMER_MINUTE2 3
#define TIMER_SECOND1 4
#define TIMER_SECOND2 5
#define TIMER_PAUSED 6
#define TIMER_RUNNING 7
#define TIMER_OVER 8

#define SETUP_TIME_SHORT 0
#define SETUP_TIME_FULL 1

#define MAX_CHAR_PER_EASTER_EGG_ITEM 200

struct Config {
  int timeFormat;
  unsigned long timer;
};

const byte alphabetInProgmem[][ROWS] PROGMEM = {
  {0,0,0,0,0,0,0,0}, // SPACE
  {0x10,0x18,0x18,0x18,0x18,0x00,0x18,0x18}, // EXCL
  {0x28,0x28,0x08,0x00,0x00,0x00,0x00,0x00}, // QUOT
  {0x00,0x0a,0x7f,0x14,0x28,0xfe,0x50,0x00}, // #
  {0x10,0x38,0x54,0x70,0x1c,0x54,0x38,0x10}, // $
  {0x00,0x60,0x66,0x08,0x10,0x66,0x06,0x00}, // %
  {0,0,0,0,0,0,0,0}, // &
  {0x30,0x30,0x40,0x00,0x00,0x00,0x00,0x00}, // '
  {0x02,0x04,0x08,0x08,0x08,0x08,0x08,0x04}, // (
  {0x40,0x20,0x10,0x10,0x10,0x10,0x10,0x20}, // )
  {0x00,0x10,0x54,0x38,0x10,0x38,0x54,0x10}, // *
  {0x00,0x08,0x08,0x08,0x7f,0x08,0x08,0x08}, // +
  {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60}, // COMMA
  {0x00,0x00,0x00,0x70,0x70,0x00,0x00,0x00}, // -
  {0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x60}, // DOT
  {0x00,0x04,0x04,0x08,0x10,0x20,0x40,0x40}, // /
  {0xf,0xd,0xd,0xd,0xd,0xd,0xd,0xf}, // 0
  {0x3,0x7,0xb,0x3,0x3,0x3,0x3,0x3}, // 1
  {0xe,0x3,0x3,0x6,0xc,0xc,0xc,0xf}, // 2
  {0xf,0x3,0x3,0xf,0x3,0x3,0x3,0xf}, // 3
  {0x8,0x8,0x9,0xf,0x3,0x3,0x3,0x3}, // 4
  {0xf,0xc,0xc,0xf,0x3,0x3,0x3,0xf}, // 5
  {0x8,0x8,0x8,0xf,0xd,0xd,0xd,0xf}, // 6
  {0xf,0x3,0x3,0x3,0x3,0x3,0x3,0x3}, // 7
  {0xf,0xd,0xd,0xf,0xd,0xd,0xd,0xf}, // 8
  {0xf,0xb,0xb,0xf,0x3,0x3,0x3,0x3}, // 9
  {0x0,0x0,0x1,0x0,0x0,0x1,0x0,0x0}, // :
  {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x08}, // ;
  {0x00,0x10,0x20,0x40,0x80,0x40,0x20,0x10}, // <
  {0x00,0x00,0x7e,0x00,0x00,0xfc,0x00,0x00}, // =
  {0x00,0x08,0x04,0x02,0x01,0x02,0x04,0x08}, // >
  {0x70,0x98,0x18,0x30,0x60,0x00,0x60,0x60}, // ?
  {0x00,0x30,0x48,0xba,0xba,0x84,0x78,0x00}, // @
  {0x70,0xc8,0xc8,0xf8,0xc8,0xc8,0xc8,0xc8}, // A
  {0xf0,0xc8,0xc8,0xf8,0xc8,0xc8,0xc8,0xf0}, // B
  {0x78,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0x78}, // C
  {0xf0,0xc8,0xc8,0xc8,0xc8,0xc8,0xc8,0xf0}, // D
  {0xf8,0xc0,0xc0,0xf0,0xc0,0xc0,0xc0,0xf8}, // E
  {0xf8,0xc0,0xc0,0xf0,0xc0,0xc0,0xc0,0xc0}, // F
  {0xf0,0xc0,0xc0,0xc0,0xd8,0xc8,0xc8,0xf0}, // G
  {0xc8,0xc8,0xc8,0xf8,0xc8,0xc8,0xc8,0xc8}, // H
  {0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60}, // I
  {0x78,0x18,0x18,0x18,0x18,0x18,0x98,0x70}, // J
  {0xc8,0xc8,0xd0,0xf0,0xf0,0xd0,0xc8,0xc8}, // K
  {0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xf8}, // L
  {0x88,0x88,0xd8,0xd8,0xa8,0xa8,0x88,0x88}, // M
  {0x88,0xc8,0xc8,0xe8,0xb8,0x98,0x98,0x98}, // N
  {0x70,0xc8,0xc8,0xc8,0xc8,0xc8,0xc8,0x70}, // O
  {0xf8,0xc8,0xc8,0xc8,0xf8,0xc0,0xc0,0xc0}, // P
  {0x70,0xc8,0xc8,0xc8,0xc8,0xc8,0xd0,0x68}, // Q
  {0xf0,0xc8,0xc8,0xf0,0xf0,0xc8,0xc8,0xc8}, // R
  {0x70,0xc8,0xc0,0x70,0x38,0x18,0x98,0x70}, // S
  {0xf0,0x60,0x60,0x60,0x60,0x60,0x60,0x60}, // T
  {0xc8,0xc8,0xc8,0xc8,0xc8,0xc8,0xc8,0x70}, // U
  {0xc8,0xc8,0xc8,0xc8,0xc8,0x70,0x70,0x20}, // V
  {0xc8,0xc8,0xc8,0xc8,0xc8,0xc8,0xe8,0x50}, // W
  {0xc8,0xc8,0x50,0x20,0x70,0x98,0x98,0x98}, // X
  {0x88,0x88,0x88,0x50,0x60,0x60,0x60,0x60}, // Y
  {0xf8,0x08,0x18,0x30,0x60,0x60,0xc0,0xf8}, // Z
};

const char easterEggTexts[][MAX_CHAR_PER_EASTER_EGG_ITEM] PROGMEM = {
  "MAEVA, N'OUBLIE PAS QUE TU ES BELLE",
  "TEST..........ICULES",
  "YOU TALKIN' TO ME?",
  "MAIS LAISSE-MOI TE CHANTEEEEEEER, D'ALLER TE FAIRE ENHUUUUMMMMMMMM",
  "QU'EST-CE QUI EST JAUNE ET QUI ATTENDS ? .............. TA MERE EN HELICOPTERE",
  "I WAS BORN READY!",
  "NON DE ZEUS, MARTY!",
  "NONOBSTANT, CA VEUT DIRE QU'IL A PAYE ?",
  "TU TUES UNE BALEINE, T'AURAS LES ECOLOS, T'AURAS GREENPEACE, T'AURAS LE COMMANDANT COUSTEAU SUR LE DOS ! MAIS DECIME UN BANC DE SARDINES, J'AIME AUTANT TE DIRE QU'ON T'AIDERA A LES METTRE EN BOITE !"
};

bool mainSwitchPressed = false, secondarySwitchPressed = false, ternarySwitchPressed = false;

LEDMatrixDriver lmd(NUM_DEVICES, MATRIX_CS_PIN);

#if CLOCK_DS1302
  DS1302 rtc(CLOCK_RESET, CLOCK_DATA, CLOCK_CLOCK);
#else
  Rtc_Pcf8563 rtc;
#endif

Config config;
unsigned int mode = MODE_CLOCK, modeSetClock, modeChrono, modeTimer, modeSetup;
unsigned int savedHour1, savedHour2, savedMinute1, savedMinute2, savedSecond1, savedSecond2, buzzerFrequency;
unsigned long chronoMillis, chronoPause, timer = 0, timerStart, timerPause, easterEggMillis = 0;
unsigned int timeFormat, buzzerStepper;

const unsigned int ANIM_DELAY = 20;

char TXT_CLOCK[] = "CLOCK";
char TXT_SET_CLOCK[] = "SET CLOCK";
char TXT_CHRONO[] = "CHRONO";
char TXT_TIMER[] = "TIMER";
char TXT_SETUP[] = "SETUP";
char TXT_SETUP_TIME_SHORT[] = "SHORT TIME FORMAT";
char TXT_SETUP_TIME_FULL[] = "FULL TIME FORMAT";
char TXT_EASTER_EGG[] = "ABCDEFGHIJKLMNOPRSTUVWXYZ";

void setup() {
  Serial.begin(9600);

  pinMode(MAIN_SWITCH_PIN, INPUT_PULLUP);
  pinMode(SECONDARY_SWITCH_PIN, INPUT_PULLUP);
  pinMode(TERNARY_SWITCH_PIN, INPUT_PULLUP);
  pinMode(BUZZER, OUTPUT);
  
  lmd.setEnabled(true);
  lmd.setIntensity(0);
  lmd.clear();
  lmd.display();

  timeFormat = getTimeFormat();
}

void loop() {
  /*
  Serial.print(getHour());
  Serial.print(":");
  Serial.print(getMinute());
  Serial.print(":");
  Serial.println(getSecond());
  delay(1000);
  */

  checkButton();

  switch(mode) {
    case MODE_CLOCK:
      displayTime();
      break;
    case MODE_SET_CLOCK:
      displaySetClock();
      break;
    case MODE_CHRONO:
      displayChrono();
      break;
    case MODE_TIMER:
      displayTimer();
      break;
    case MODE_SETUP:
      displaySetup();
      break;
    case MODE_EASTER_EGG:
      displayEasterEgg();
      break;
  }

  delay(ANIM_DELAY);
}
